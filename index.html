<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oncredit Dashboard – Live from Google Sheet</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
<style>
:root{
    --bg:#f8f9fc;--text:#2c3e50;--card:#fff;--border:#e6e8eb;
    --primary:#3498db;--pos:#27ae60;--neg:#e74c3c;--warn:#e67e22;--info:#2980b9;
    --shadow:0 3px 10px rgba(0,0,0,.08);
}
[data-theme="dark"]{
    --bg:#1a1a1a;--text:#ecf0f1;--card:#2c2c2c;--border:#3a3a3a;
    --primary:#5dade2;--pos:#2ecc71;--neg:#e74c3c;--warn:#f39c12;--info:#3498db;
    --shadow:0 3px 10px rgba(0,0,0,.3);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);padding:20px;transition:all .3s;}
.container{max-width:1000px;margin:auto;}
.header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:12px;}
h1{color:var(--primary);font-size:1.8rem;}
.subtitle{color:#7f8c8d;font-size:.92rem;margin-bottom:18px;text-align:center;}
.controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:16px 0 6px;}
#agentSelect, #datePicker{padding:12px 16px;font-size:16px;width:300px;max-width:100%;border:1px solid var(--primary);border-radius:10px;background:var(--card);color:var(--text);box-shadow:var(--shadow);}
.btn{padding:10px 16px;font-size:14px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;transition:.2s;box-shadow:var(--shadow);}
.btn:hover{transform:translateY(-1px);background:var(--primary);color:#fff;}
.target-btn{background:var(--primary);color:#fff;font-weight:bold;margin:4px;border-radius:30px;padding:8px 16px;}
.target-btn.selected{background:var(--pos);border-color:var(--pos);}
.mode-toggle{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--text);}
.tabs{display:flex;justify-content:center;margin:18px 0 10px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.tab{padding:10px 18px;cursor:pointer;font-weight:600;color:#7f8c8d;border-bottom:3px solid transparent;transition:.25s;margin:0 5px;}
.tab.active{color:var(--primary);border-bottom:3px solid var(--primary);}
.tab-content{display:none;padding:18px 0;}
.tab-content.active{display:block;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:15px;margin:16px 0 6px;}
.stat-card{background:var(--card);padding:16px;border-radius:12px;text-align:center;box-shadow:var(--shadow);transition:transform .2s;}
.stat-card:hover{transform:translateY(-3px);}
.stat-card h3{font-size:.84rem;color:#7f8c8d;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:6px;}
.stat-card p{font-size:1.22rem;font-weight:bold;margin:0;}
.positive{color:var(--pos);}
.negative{color:var(--neg);}
.info{color:var(--info);}
.warning{color:var(--warn);}
.progress-wrap{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);}
.progress-row{display:flex;align-items:center;gap:12px;margin-top:6px;}
.progress-bar{flex:1;height:12px;background:#ecf0f1;border-radius:999px;overflow:hidden;}
[data-theme="dark"] .progress-bar{background:#3a3a3a;}
.progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),#2980b9);border-radius:999px;transition:width .7s ease;}
.progress-percent{min-width:64px;text-align:right;font-weight:600;font-size:.92rem;color:var(--text);}
.bucket-section{background:var(--card);padding:18px;border-radius:12px;margin-bottom:20px;box-shadow:var(--shadow);}
.bucket-title{font-size:1.08rem;font-weight:600;color:var(--text);margin-bottom:12px;text-align:center;padding-bottom:8px;border-bottom:2px solid var(--border);display:flex;align-items:center;justify-content:center;gap:8px;}
table{width:100%;border-collapse:collapse;font-size:.92rem;}
th{background:var(--primary);color:#fff;padding:10px;text-align:center;}
td{padding:10px;text-align:center;border-bottom:1px solid var(--border);}
tr:hover{background:rgba(52,152,219,.1);}
[data-theme="dark"] tr:hover{background:rgba(52,152,219,.2);}
.amount{font-weight:600;color:var(--pos);}
.footer{text-align:center;margin-top:20px;color:#95a5a6;font-size:.8rem;}
.target-selection{margin:12px 0;text-align:center;}
#loading{display:none;text-align:center;color:var(--primary);font-weight:600;margin:20px;}
@media(max-width:600px){
    .header{flex-direction:column;text-align:center;}
    .controls{flex-direction:column;}
    #agentSelect,#datePicker{width:100%;}
    .stats-grid{grid-template-columns:1fr 1fr;}
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Oncredit Dashboard</h1>
        <button id="themeToggle" class="mode-toggle"><i class="fas fa-moon"></i></button>
    </div>
    <p class="subtitle">November 2025 | Live from Google Sheet</p>

    <div id="loading">Loading data from Google Sheet...</div>

    <div class="controls">
        <select id="agentSelect" onchange="updateStats()">
            <option value="">-- Select Agent --</option>
        </select>
        <select id="datePicker" onchange="updateStats()">
            <option value="">-- Select Date --</option>
        </select>
        <button class="btn" onclick="clearSelection()">Clear</button>
        <button class="btn" onclick="fetchData()">Refresh Data</button>
    </div>

    <div class="target-selection" id="targetBox" style="display:none;">
        <strong>Select Monthly Target:</strong><br>
        <button class="btn target-btn" data-val="6000000">6Mn</button>
        <button class="btn target-btn" data-val="7000000">7Mn</button>
        <button class="btn target-btn" data-val="8000000">8Mn</button>
        <button class="btn target-btn" data-val="9000000">9Mn</button>
        <button class="btn target-btn" data-val="10000000">10Mn</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="openTab('agent')">Agent Stats</div>
        <div class="tab" onclick="openTab('without')">Without+Pre+Due</div>
        <div class="tab" onclick="openTab('soft')">Soft</div>
        <div class="tab" onclick="openTab('medium')">Medium</div>
        <div class="tab" onclick="openTab('hard')">Hard</div>
        <div class="tab" onclick="openTab('restruct')">Restruct</div>
    </div>

    <!-- AGENT STATS -->
    <div id="agent" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card"><h3>Monthly Target</h3><p id="target" class="info">-</p></div>
            <div class="stat-card"><h3>Collected (YTD)</h3><p id="collected" class="positive">-</p></div>
            <div class="stat-card"><h3>Deficit</h3><p id="deficit" class="negative">-</p></div>
            <div class="stat-card"><h3>Days Left</h3><p id="daysLeft" class="info">-</p></div>
            <div class="stat-card"><h3>Required Daily Avg</h3><p id="dailyRequired" class="warning">-</p></div>
            <div class="stat-card"><h3>Calls Today</h3><p id="callsToday" class="info">-</p></div>
            <div class="stat-card"><h3>New Loan Count</h3><p id="newLoans" class="info">-</p></div>
            <div class="stat-card"><h3>Bonus</h3><p id="bonus" class="positive">-</p></div>
        </div>

        <div class="progress-wrap">
            <div style="display:flex;justify-content:space-between;">
                <strong>Progress to Target</strong>
                <small id="progressCaption">0% of target</small>
            </div>
            <div class="progress-row">
                <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
                <div id="progressPercent" class="progress-percent">0%</div>
            </div>
        </div>
    </div>

    <!-- BUCKETS -->
    <div id="without" class="tab-content"><div class="bucket-section"><div class="bucket-title">Top 5 – Without+Pre+Due</div><table id="tblWithout"><thead><tr><th>Rank</th><th>Agent</th><th>Collected</th></tr></thead><tbody></tbody></table></div></div>
    <div id="soft" class="tab-content"><div class="bucket-section"><div class="bucket-title">Top 5 – Soft</div><table id="tblSoft"><thead><tr><th>Rank</th><th>Agent</th><th>Collected</th></tr></thead><tbody></tbody></table></div></div>
    <div id="medium" class="tab-content"><div class="bucket-section"><div class="bucket-title">Top 5 – Medium</div><table id="tblMedium"><thead><tr><th>Rank</th><th>Agent</th><th>Collected</th></tr></thead><tbody></tbody></table></div></div>
    <div id="hard" class="tab-content"><div class="bucket-section"><div class="bucket-title">Top 5 – Hard</div><table id="tblHard"><thead><tr><th>Rank</th><th>Agent</th><th>Collected</th></tr></thead><tbody></tbody></table></div></div>
    <div id="restruct" class="tab-content"><div class="bucket-section"><div class="bucket-title">Top 5 – Restruct</div><table id="tblRestruct"><thead><tr><th>Rank</th><th>Agent</th><th>Collected</th></tr></thead><tbody></tbody></table></div></div>

    <div class="footer" id="footerNote"></div>
</div>

<script>
// === YOUR PUBLISHED CSV LINK (ENTIRE DOCUMENT) ===
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQLhHuXwdx3qvaDJ0wbiH_u7MQAMk_sdeb8DDor-Zyhn8rDi4O9oj91L1FtlxdOeqheEiikqKizeBm0/pub?output=csv";

let allRows = [];
let selectedAgent = '';
let selectedDate = '';
let selectedTarget = 6000000;

// Format LKR
function formatLKR(n) {
    return "LKR " + Number(n || 0).toLocaleString('en-LK', { maximumFractionDigits: 0 });
}

// Parse CSV
function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const values = [];
        let field = '', inQuote = false;
        for (let char of lines[i] + ',') {
            if (char === '"') inQuote = !inQuote;
            else if (char === ',' && !inQuote) { values.push(field.trim()); field = ''; }
            else field += char;
        }
        if (values.length < headers.length) continue;
        const obj = {};
        headers.forEach((h, idx) => {
            let val = values[idx] || '';
            val = val.replace(/"/g, '').trim();
            obj[h] = isNaN(val) || val === '' ? val : Number(val);
        });
        rows.push(obj);
    }
    return rows;
}

// Fetch Data
async function fetchData() {
    document.getElementById('loading').style.display = 'block';
    try {
        const resp = await fetch(CSV_URL + '&_=' + Date.now());
        if (!resp.ok) throw new Error('Network error');
        const text = await resp.text();
        allRows = parseCSV(text);
        console.log('Loaded', allRows.length, 'rows');
        populateFilters();
        document.getElementById('loading').style.display = 'none';
    } catch (e) {
        console.error(e);
        alert('Failed to load data. Check CSV link.');
        document.getElementById('loading').style.display = 'none';
    }
}

// Populate Filters
function populateFilters() {
    const agents = [...new Set(allRows.map(r => r['Operator Name']))].filter(Boolean).sort();
    const dates = [...new Set(allRows.map(r => r['Date']))].filter(Boolean).sort().reverse();

    const agentSel = document.getElementById('agentSelect');
    agentSel.innerHTML = '<option value="">-- Select Agent --</option>' +
        agents.map(a => `<option value="${a}">${a}</option>`).join('');

    const dateSel = document.getElementById('datePicker');
    dateSel.innerHTML = '<option value="">-- Select Date --</option>' +
        dates.map(d => `<option value="${d}">${d}</option>`).join('');

    if (dates.length > 0) {
        dateSel.value = dates[0];
        selectedDate = dates[0];
    }
    updateStats();
}

// Update Stats
function updateStats() {
    selectedAgent = document.getElementById('agentSelect').value;
    selectedDate = document.getElementById('datePicker').value;
    document.getElementById('targetBox').style.display = selectedAgent ? 'block' : 'none';

    if (!selectedAgent || !selectedDate) {
        clearStats();
        return;
    }

    const saved = localStorage.getItem(`target_${selectedAgent}`);
    selectedTarget = saved ? Number(saved) : 6000000;
    document.querySelectorAll('.target-btn').forEach(b => {
        b.classList.toggle('selected', Number(b.dataset.val) === selectedTarget);
    });

    calculateStats();
    updateBuckets();
}

function clearStats() {
    document.getElementById('target').textContent = '-';
    document.getElementById('collected').textContent = '-';
    document.getElementById('deficit').textContent = '-';
    document.getElementById('dailyRequired').textContent = '-';
    document.getElementById('callsToday').textContent = '-';
    document.getElementById('newLoans').textContent = '-';
    document.getElementById('bonus').textContent = '-';
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressPercent').textContent = '0%';
    document.getElementById('progressCaption').textContent = '0% of target';
}

// Calculate Stats
function calculateStats() {
    const row = allRows.find(r => r['Date'] === selectedDate && r['Operator Name'] === selectedAgent);
    if (!row) {
        alert('No data for this agent/date');
        return;
    }

    const ytd = row.Collected || 0;
    const bonus = row['Total Bonusses'] || 0;
    const calls = row['Call count'] || 0;
    const newLoans = row['New loan count'] || 0;
    const deficit = selectedTarget - ytd;
    const daysLeft = 20;
    const dailyReq = deficit > 0 ? Math.ceil(deficit / daysLeft) : 0;

    document.getElementById('target').textContent = formatLKR(selectedTarget);
    document.getElementById('collected').textContent = formatLKR(ytd);
    const defEl = document.getElementById('deficit');
    defEl.textContent = formatLKR(Math.abs(deficit));
    defEl.className = deficit > 0 ? 'negative' : 'positive';
    document.getElementById('daysLeft').textContent = daysLeft;
    document.getElementById('dailyRequired').textContent = formatLKR(dailyReq) + '/day';
    document.getElementById('callsToday').textContent = calls;
    document.getElementById('newLoans').textContent = newLoans;
    document.getElementById('bonus').textContent = formatLKR(bonus);

    const pct = selectedTarget > 0 ? (ytd / selectedTarget) * 100 : 0;
    const pctR = Math.min(Math.round(pct), 300);
    const fill = document.getElementById('progressFill');
    fill.style.width = Math.min(pctR, 100) + '%';
    document.getElementById('progressPercent').textContent = pctR + '%';
    document.getElementById('progressCaption').textContent = pctR + '% of target';
}

// Update Buckets
function updateBuckets() {
    const today = allRows.filter(r => r.Date === selectedDate);
    const buckets = {
        without: 'Without+Pre+Due Collection',
        soft: 'Soft Collection',
        medium: 'Medium Collection',
        hard: 'Hard Collection',
        restruct: 'Restruct Collection'
    };

    Object.entries(buckets).forEach(([key, col]) => {
        const sorted = today
            .map(r => ({ name: r['Operator Name'], amt: Number(r[col]) || 0 }))
            .sort((a, b) => b.amt - a.amt)
            .slice(0, 5);
        const tbody = document.querySelector(`#tbl${key.charAt(0).toUpperCase() + key.slice(1)} tbody`);
        tbody.innerHTML = sorted.map((x, i) => `
            <tr><td>${i+1}</td><td>${x.name}</td><td class="amount">${formatLKR(x.amt)}</td></tr>
        `).join('');
    });
}

// Target Buttons
document.querySelectorAll('.target-btn').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.target-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedTarget = Number(btn.dataset.val);
        localStorage.setItem(`target_${selectedAgent}`, selectedTarget);
        calculateStats();
    };
});

// Tab Switch
function openTab(id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[onclick="openTab('${id}')"]`).classList.add('active');
    if (id === 'agent') updateStats();
}

function clearSelection() {
    document.getElementById('agentSelect').value = '';
    document.getElementById('datePicker').value = '';
    document.getElementById('targetBox').style.display = 'none';
    clearStats();
}

// Theme Toggle
document.getElementById('themeToggle').onclick = () => {
    const isDark = document.body.getAttribute('data-theme') === 'dark';
    document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    localStorage.setItem('theme', isDark ? 'light' : 'dark');
};

// Auto-refresh every 5 minutes
setInterval(fetchData, 5 * 60 * 1000);

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    fetchData();
    document.getElementById('footerNote').innerHTML = `Live from Google Sheet | Auto-refresh every 5 min | <strong>51 Agents</strong>`;
    const theme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', theme);
});
</script>
</body>
</html>
